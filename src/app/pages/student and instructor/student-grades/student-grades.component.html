<app-notification></app-notification>
<div class="student-grades-container">
  <div class="grades-header">
    <h2>
      <i class="fas fa-medal"></i>
      Điểm của tôi
    </h2>
    
    <div class="tabs">
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'ALL'"
        (click)="changeTab('ALL')">
        Tất cả
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'MULTIPLE_CHOICE'"
        (click)="changeTab('MULTIPLE_CHOICE')">
        Trắc nghiệm
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab === 'ESSAY'"
        (click)="changeTab('ESSAY')">
        Tự luận
      </button>
    </div>
  </div>

  <!-- Loading state -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Đang tải điểm của bạn...</p>
  </div>

  <!-- Grades grid -->
  <div *ngIf="!isLoading" class="grades-grid">
    <div *ngIf="filteredGrades.length === 0" class="no-data">
      <i class="fas fa-clipboard-list"></i>
      <p>Bạn chưa có điểm nào</p>
      <small>Hãy tham gia các bài kiểm tra để xem điểm ở đây</small>
    </div>

    <div *ngFor="let grade of filteredGrades" class="grade-card">
      <div class="card-header">
        <div class="quiz-info">
          <h3>{{ grade.quizTitle }}</h3>
          <p class="course-name">{{ grade.courseName }}</p>
        </div>
        <span class="quiz-type-badge" [class.essay]="grade.quizType === 'ESSAY'">
          {{ grade.quizType === 'ESSAY' ? 'Tự luận' : 'Trắc nghiệm' }}
        </span>
      </div>

      <div class="card-body">
        <div class="score-section">
          <div class="score-display" [class]="getScoreClass(grade.score, grade.maxScore)">
            <span class="score">{{ getCorrectAnswers(grade) }}</span>
            <span class="separator">/</span>
            <span class="max-score">{{ grade.maxScore }}</span>
          </div>
          <div class="percentage">
            {{ getPercentage(grade).toFixed(1) }}%
          </div>
        </div>

        <div class="status-section">
          <span [class]="getStatusBadgeClass(grade.status)">
            {{ grade.status === 'COMPLETED' ? 'Hoàn thành' : 
               grade.status === 'PENDING_GRADE' ? 'Chờ chấm điểm' : 'Chưa nộp' }}
          </span>
        </div>

        <div class="date-section">
          <i class="fas fa-clock"></i>
          <span>{{ formatDate(grade.submittedAt) }}</span>
        </div>

        <div *ngIf="grade.feedback" class="feedback-section">
          <h4>Nhận xét từ giảng viên:</h4>
          <p>{{ grade.feedback }}</p>
        </div>

        <!-- View details button for essay -->
        <div *ngIf="grade.quizType === 'ESSAY'" class="actions-section">
          <button 
            class="btn btn-primary btn-sm"
            (click)="viewEssaySubmission(grade)"
            [disabled]="isLoadingSubmission">
            <i class="fas fa-eye"></i>
            Xem chi tiết bài làm
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Essay Submission Modal -->
  <div 
    *ngIf="selectedSubmission" 
    class="modal fade"
    [class.show]="selectedSubmission"
    tabindex="-1"
    role="dialog">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-file-alt"></i>
            Chi tiết bài làm: {{ selectedSubmission.quizTitle }}
          </h5>
          <button 
            type="button" 
            class="btn-close" 
            (click)="closeEssayModal()"
            aria-label="Close">
          </button>
        </div>

        <div class="modal-body">
          <!-- Loading state -->
          <div *ngIf="isLoadingSubmission" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p>Đang tải chi tiết bài làm...</p>
          </div>

          <!-- Submission details -->
          <div *ngIf="!isLoadingSubmission && selectedSubmission">
            <!-- Summary -->
            <div class="submission-summary">
              <div class="row">
                <div class="col-md-3 col-6">
                  <strong>Ngày nộp</strong><br>
                  <span>{{ formatDate(selectedSubmission.submittedAt) }}</span>
                </div>
                <div class="col-md-3 col-6">
                  <strong>Tổng số câu</strong><br>
                  <span>{{ selectedSubmission.totalQuestions }}</span>
                </div>
                <div class="col-md-3 col-6">
                  <strong>Điểm số</strong><br>
                  <span [class]="selectedSubmission.isFullyGraded ? 'text-success' : 'text-warning'">
                    {{ getEssayScoreDisplay(selectedSubmission) }}
                  </span>
                </div>
                <div class="col-md-3 col-6">
                  <strong>Phần trăm</strong><br>
                  <span [class]="selectedSubmission.isFullyGraded ? 'text-success' : 'text-warning'">
                    {{ getEssayPercentage(selectedSubmission).toFixed(1) }}%
                  </span>
                </div>
              </div>
            </div>

            <!-- Questions and answers -->
            <div class="questions-answers">
              <div 
                *ngFor="let question of selectedSubmission.questions; let i = index" 
                class="question-block">
                
                <div class="question-header">
                  <h5>
                    <span *ngIf="selectedSubmission.questions.length > 1">Câu {{ i + 1 }}: </span><strong>Câu hỏi: </strong>{{ question.questionText }}
                  </h5>
                </div>

                <div class="answer-section">
                  <ng-container *ngIf="getAnswerForQuestion(question.questionId) as answer">
                    <div class="student-answer">
                      <strong>Bài làm của bạn:</strong>
                      <div class="answer-content">
                        <!-- Check if any answer exists -->
                        <div *ngIf="!answer.answerText && !answer.linkAnswer && !answer.fileName" class="no-content">
                          <em class="text-muted">Bạn chưa trả lời câu hỏi này</em>
                        </div>
                        
                        <div *ngIf="answer.answerText" class="text-answer">
                          {{ answer.answerText }}
                        </div>
                        <div *ngIf="answer.linkAnswer" class="link-answer">
                          <a [href]="answer.linkAnswer" target="_blank" rel="noopener noreferrer">
                            {{ answer.linkAnswer }}
                          </a>
                        </div>
                        <div *ngIf="answer.fileName" class="file-answer">
                          <i class="fas fa-file-download"></i>
                          <span>{{ answer.fileName }}</span>
                        </div>
                      </div>
                    </div>

                    <!-- Grading info -->
                    <div class="grading-info">
                      <div class="row">
                        <div class="col-md-6">
                          <strong>Điểm số:</strong>
                          <span 
                            *ngIf="answer.manualScore !== null && answer.manualScore !== undefined"
                            [class]="answer.manualScore > 0 ? 'text-success' : 'text-danger'">
                            {{ answer.manualScore }}/1 điểm
                          </span>
                          <span *ngIf="answer.manualScore === null || answer.manualScore === undefined" class="text-warning">
                            Chưa chấm điểm
                          </span>
                        </div>
                        <div class="col-md-6">
                          <strong>Trạng thái:</strong>
                          <span 
                            *ngIf="answer.manualScore !== null && answer.manualScore !== undefined"
                            [class]="answer.manualScore > 0 ? 'text-success' : 'text-danger'">
                            {{ answer.manualScore > 0 ? 'Đạt' : 'Không đạt' }}
                          </span>
                          <span *ngIf="answer.manualScore === null || answer.manualScore === undefined" class="text-warning">
                            Đang chờ
                          </span>
                        </div>
                      </div>
                      
                      <div *ngIf="answer.instructorFeedback" class="feedback">
                        <strong>Nhận xét từ giảng viên:</strong><br>
                        {{ answer.instructorFeedback }}
                      </div>
                      <div *ngIf="!answer.instructorFeedback && answer.manualScore !== null" class="feedback">
                        <em class="text-muted">Giảng viên chưa để lại nhận xét cho câu này.</em>
                      </div>
                    </div>
                  </ng-container>

                  <div *ngIf="!getAnswerForQuestion(question.questionId)" class="no-answer">
                    <em>Không có bài làm cho câu hỏi này</em>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="closeEssayModal()">
            <i class="fas fa-times"></i>
            Đóng
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal backdrop -->
  <div 
    *ngIf="selectedSubmission" 
    class="modal-backdrop fade"
    [class.show]="selectedSubmission"
    (click)="closeEssayModal()">
  </div>
</div>
